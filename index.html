<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles (No Changes) --- */
        :root {
            --primary-bg: #0F172A; /* Dark blue-gray */
            --secondary-bg: #1E293B; /* Slightly lighter blue-gray */
            --card-bg: #1E293B;
            --text-primary: #E2E8F0; /* Light gray for primary text */
            --text-secondary: #94A3B8; /* Muted gray for secondary text */
            --accent-color: #FACC15; /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue for primary actions */
            --border-color: #334155; /* Border color */
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981; /* Green for success */
            --danger-color: #EF4444; /* Red for danger/errors */
            --warning-color: #F59E0B; /* Orange for warnings */
            --info-color: #3B82F6; /* Blue for info */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); color: var(--text-primary); padding-top: 70px; padding-bottom: 75px; min-height: 100vh; overscroll-behavior-y: contain; }
        a { color: var(--accent-color); text-decoration: none; } a:hover { color: #FBBF24; }
        .main-content { padding: 15px; } .section { display: none; animation: fadeIn 0.3s ease-in-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); } .custom-card { background-color: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); } .btn-custom { border-radius: 6px; font-size: 0.9rem; font-weight: 500; padding: 8px 15px; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.2s ease, filter 0.2s ease; } .btn-custom-primary { background-color: var(--primary-button-bg); color: var(--text-primary); } .btn-custom-primary:hover { background-color: #2563EB; } .btn-custom-secondary { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .btn-custom-secondary:hover { background-color: #334155; } .btn-custom-accent { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .btn-custom-accent:hover { filter: brightness(1.1); } .btn-custom-link { background: none; border: none; color: var(--primary-button-bg); font-size: 0.9rem; font-weight: 500; padding: 0; cursor: pointer; } .text-accent { color: var(--accent-color); } .text-success { color: var(--success-color); } .text-danger { color: var(--danger-color); } .text-warning { color: var(--warning-color); } .form-control { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; } .form-control:focus { background-color: var(--primary-bg); border-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); } .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; } .form-label { color: var(--text-secondary); font-size: 0.9rem; } .alert { border-radius: 6px; font-size: 0.9rem; } .list-group-item { background-color: var(--card-bg); color: var(--text-primary); border: none; border-bottom: 1px solid var(--border-color); padding: 15px; font-size: 0.95rem; transition: background-color 0.2s ease; } .list-group-item:hover { background-color: rgba(255, 255, 255, 0.05); } .list-group-item:last-child { border-bottom: none; } .list-group-item i:first-child { color: var(--accent-color); margin-right: 15px; font-size: 1.1rem; width: 20px; text-align: center; } .list-group-item .bi-chevron-right { color: var(--text-secondary); font-size: 0.9rem; } #globalLoaderEl { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; } .spinner-border { color: var(--accent-color); width: 3rem; height: 3rem; } .placeholder-glow .placeholder { background-color: rgba(51, 65, 85, 0.5); animation: placeholder-glow 2s ease-in-out infinite; } .placeholder { background-color: rgba(51, 65, 85, 0.5); border-radius: 4px; } @keyframes placeholder-glow { 0% { background-color: rgba(51, 65, 85, 0.5); } 50% { background-color: rgba(51, 65, 85, 0.7); } 100% { background-color: rgba(51, 65, 85, 0.5); } } .interactive-list-item { cursor: pointer; } .referral-code { font-family: monospace; letter-spacing: 1px; user-select: all; } .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-bottom: 1px solid var(--border-color); } .header-left { display: flex; align-items: center; gap: 10px; } .header-logo { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color); } .header-title { font-size: 0.9rem; font-weight: 500; line-height: 1.2; } .header-title span { font-size: 0.75rem; color: var(--text-secondary); display: block; } .header-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; margin-right: 5px; display: none; padding: 5px; } .header-right { display: flex; align-items: center; gap: 15px; } .notification-icon { font-size: 1.3rem; color: var(--text-primary); position: relative; background: none; border: none; padding: 0; } .notification-badge { position: absolute; top: -3px; right: -5px; background-color: var(--danger-color); color: white; font-size: 0.6rem; width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; } .wallet-chip { background: var(--accent-gradient); color: var(--primary-bg); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; font-size: 0.85rem; font-weight: 700; border: none; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); cursor: pointer; } .wallet-chip i { margin-right: 5px; font-size: 0.9rem; } .header-game-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 10px; display: none; } .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--bottom-nav-bg); display: flex; justify-content: space-around; align-items: stretch; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-top: 1px solid var(--border-color); } .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; flex-grow: 1; padding: 8px 0; transition: color 0.2s ease, background-color 0.2s ease; border: none; background: none; cursor: pointer; font-size: 0.7rem; } .nav-item i { font-size: 1.4rem; margin-bottom: 4px; line-height: 1; } .nav-item span { font-size: 0.7rem; font-weight: 500; line-height: 1; } .nav-item.active { color: var(--accent-color); background-color: rgba(250, 204, 21, 0.1); } .swiper-container#promotionSliderEl { width: 100%; height: 100%; border-radius: 10px; margin-bottom: 25px; --swiper-pagination-color: var(--accent-color); --swiper-pagination-bullet-inactive-color: var(--text-secondary); --swiper-pagination-bullet-size: 8px; } .swiper-slide { background-color: var(--secondary-bg); border-radius: 10px; } .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; } .game-card { text-align: center; background-color: var(--card-bg); border-radius: 8px; overflow: hidden; padding: 0; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s ease; } .game-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); } .game-card img { width: 100%; height: 130px; object-fit: cover; display: block; } .game-card span { display: block; padding: 10px 5px; font-weight: 500; font-size: 0.9rem; color: var(--text-primary); } .tournament-tabs { display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; } .tab-item { color: var(--text-secondary); background: none; border: none; padding: 8px 10px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; flex-grow: 1; text-align: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; } .tab-item.active { background-color: var(--primary-button-bg); color: var(--text-primary); } .tab-item i { margin-right: 5px; }
        .tournament-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; } .tournament-card-tags span { background-color: var(--primary-bg); color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; padding: 3px 8px; border-radius: 4px; display: inline-block; border: 1px solid var(--border-color); margin-right: 4px; margin-bottom: 4px; } .tournament-card-timer { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 4px; } .tournament-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); } .tournament-card-title i { color: var(--accent-color); } .tournament-card-info { display: flex; justify-content: space-between; align-items: stretch; border-top: 1px dashed var(--border-color); border-bottom: 1px dashed var(--border-color); padding: 10px 0; margin: 10px 0; font-size: 0.8rem; } .info-item { text-align: center; flex: 1; padding: 0 5px; } .info-item span { display: block; color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px; } .info-item strong { color: var(--text-primary); font-weight: 600; font-size: 0.9rem; } .info-item .prize-icon { color: var(--accent-color); font-size: 1.2rem; } .tournament-card-spots { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px; } .tournament-card-spots span { font-weight: 600; } .progress { height: 6px; background-color: var(--primary-bg); border-radius: 3px; overflow: hidden; } .progress-bar { background-color: var(--warning-color); transition: width 0.3s ease; } .tournament-card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; } .tournament-card-actions .btn-sm { padding: 8px 10px; font-size: 0.85rem; width: 100%; } .tournament-card-actions .btn-join { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; grid-column: 2 / 3; } .tournament-card-actions .btn-details { background-color: var(--secondary-bg); border: 1px solid var(--border-color); grid-column: 1 / 2; } .tournament-card-actions .btn-joined { background-color: var(--success-color); color: var(--text-primary); opacity: 0.8; grid-column: 2 / 3; } .tournament-card-actions .btn-disabled { background-color: var(--secondary-bg); opacity: 0.6; cursor: not-allowed; grid-column: 2 / 3; } .btn-idpass { background: var(--accent-gradient); color: var(--primary-bg); border: none; font-weight: 600; } .wallet-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color); } .wallet-card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 25px; } .balance-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); } .balance-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; } .balance-item-label { font-size: 0.95rem; color: var(--text-secondary); } .balance-item-value { font-size: 1.1rem; font-weight: 600; } .balance-item-action { min-width: 100px; text-align: right; } .balance-item-action .btn-custom-link { font-size: 0.85rem; color: var(--accent-color); padding: 5px; } .balance-item-action .btn-withdraw { background-color: var(--primary-button-bg); color: #fff; font-size: 0.8rem; padding: 5px 12px; border-radius: 5px; border: none; } #recentTransactionsListEl .custom-card { background-color: var(--secondary-bg); } .profile-header-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); } .profile-avatar { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--accent-color); object-fit: cover; background-color: var(--primary-bg); } .profile-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; } .profile-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px; word-break: break-all; } .profile-stats { display: flex; justify-content: space-around; width: 100%; border-top: 1px solid var(--border-color); padding-top: 15px; } .stat-item { text-align: center; flex: 1; } .stat-item strong { display: block; font-size: 1rem; font-weight: 600; } .stat-item span { font-size: 0.75rem; color: var(--text-secondary); } .profile-links .list-group { border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); } .profile-links .form-switch .form-check-input { background-color: var(--secondary-bg); border-color: var(--border-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e"); } .profile-links .form-switch .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); } #login-section { margin-top: 5vh; } #login-section .card { background-color: var(--card-bg); border: 1px solid var(--border-color); } #login-section .btn-primary { background-color: var(--primary-button-bg); border: none; } #login-section .btn-link { background: none; border: none; color: var(--accent-color); text-decoration: none; font-size: 0.9em; padding: 5px 0; } #login-section .btn-link:hover { text-decoration: underline; } #login-section .btn-success { background-color: var(--success-color); border: none; } #login-section .btn-danger { background-color: var(--danger-color); border: none; } #login-section .form-divider { text-align: center; margin: 20px 0; position: relative; color: var(--text-secondary); } #login-section .form-divider::before, #login-section .form-divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background-color: var(--border-color); } #login-section .form-divider::before { left: 0; } #login-section .form-divider::after { right: 0; } #login-section .form-divider span { background-color: var(--card-bg); padding: 0 10px; position: relative; z-index: 1; font-size: 0.8rem; font-weight: 500; } #login-section .card-title { color: var(--text-primary); } #googleSignInBtnMainEl { display: none; } .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .modal-header { border-bottom-color: var(--border-color); } .modal-footer { border-top-color: var(--border-color); } .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } .modal-body .phonepe-number { color: var(--warning-color); font-weight: bold; user-select: text; } #matchDetailsModalBodyEl pre { background-color: var(--primary-bg); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; } #policyModalBodyEl { line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; } #idPasswordModalEl .copy-btn { padding: 2px 6px; font-size: 0.8rem; margin-left: 8px; vertical-align: middle; } #policyModalBodyEl .copy-btn, #policyModalBodyEl #shareReferralBtn { padding: 4px 10px; font-size: 0.9rem; } #policyModalBodyEl #shareReferralBtn i, #policyModalBodyEl .copy-btn i { margin-right: 5px; } #securityWarning { background-color: var(--danger-color); color: white; padding: 10px 15px; text-align: center; font-size: 0.9rem; position: sticky; top: 60px; z-index: 999; border-bottom: 1px solid #a51d1d; } #securityWarning a { color: #ffdddd; text-decoration: underline; } #securityWarning button { background: none; border: 1px solid white; color: white; padding: 2px 8px; margin-left: 15px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }
        
        /* --- NEW/MODIFIED STYLES START --- */
        .tournament-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            overflow: hidden; /* Important for containing the image's corners */
        }
        .tournament-banner-img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }
        .tournament-content-wrapper {
            padding: 15px;
        }
        .results-table-container { margin-top: 15px; }
        .results-table { width: 100%; font-size: 0.85rem; color: var(--text-primary); border-collapse: collapse; }
        .results-table th, .results-table td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .results-table th { font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
        .results-table .user-highlight, .leaderboard-item.user-highlight { background-color: rgba(250, 204, 21, 0.15) !important; font-weight: bold; border-left: 3px solid var(--accent-color); border-right: 3px solid var(--accent-color);}
        .results-table td:nth-child(1) { text-align: center; font-weight: bold; } /* Rank */
        .results-table td:nth-child(3) { text-align: center; } /* Kills */
        .results-table td:nth-child(4) { text-align: right; font-weight: bold; white-space: nowrap; } /* Prize */

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }
        .leaderboard-rank {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-secondary);
            width: 40px;
            text-align: center;
        }
        .leaderboard-avatar {
            width: 0px;
            height: 0px;
            border-radius: 0%;
            object-fit: cover;
            margin-left: 0px;
            margin-right: 0px;
            border: 0px solid var(--border-color);
        }
        .leaderboard-info {
            flex-grow: 1;
        }
        .leaderboard-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        .leaderboard-winnings {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success-color);
            text-align: right;
        }
        
        /* Styles for Notifications */
        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background-color: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid transparent;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            cursor: pointer;
        }
        .notification-item.unread {
            border-left-color: var(--accent-color);
        }
        .notification-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .notification-icon-container {
            font-size: 1.5rem;
            color: var(--text-secondary);
            width: 30px;
            text-align: center;
            margin-top: 2px;
        }
        .notification-content { flex-grow: 1; }
        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        .notification-body {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .notification-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.8;
            margin-top: 8px;
        }
        .notification-item .placeholder { border-radius: 4px; }
        .notification-item .notification-icon-container .placeholder {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            margin: auto;
        }
        /* --- NEW/MODIFIED STYLES END --- */
    </style>
</head>

<body>
     <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo" id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> <span id="headerUserGreetingEl">Guest</span> </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl" style="display: none;"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i class="bi bi-wallet-fill"></i>₹<span id="headerChipBalanceEl">0</span> </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl"> <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> </div>

        <!-- Login Section -->
        <section id="login-section" class="section">
             <div class="container" style="max-width: 450px;">
                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required> </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Sign Up</h2>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label> <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div>
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                 </div>
                 <div class="swiper-pagination"></div>
            </div>
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div> <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
            </div>
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <div class="tournament-content-wrapper"><span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> <div class="tournament-card placeholder-glow mb-3"> <div class="tournament-content-wrapper"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div> </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
             <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-withdraw" id="withdrawBtnEl">Withdraw</button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action" style="min-width: 100px;"></div> </div>
                <button class="btn btn-custom btn-custom-secondary w-100 mt-4" id="addAmountWalletBtnEl"> <i class="bi bi-plus-circle-fill me-2"></i>Add Amount </button>
            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow"> <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div> <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> </div>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboard-section" class="section">
            <h2 class="section-title">Global Leaderboard</h2>
            <p class="text-secondary small mb-3">Top 10 players by total winnings.</p>
            <div id="leaderboardListEl" class="placeholder-glow">
                <!-- Placeholder for a leaderboard item -->
                <div class="leaderboard-item placeholder-glow">
                    <span class="leaderboard-rank placeholder col-1"></span>
                    <span class="placeholder leaderboard-avatar" style="width: 45px; height: 45px; border-radius: 50%;"></span>
                    <div class="leaderboard-info flex-grow-1">
                        <span class="placeholder col-5"></span>
                    </div>
                    <span class="leaderboard-winnings placeholder col-3"></span>
                </div>
            </div>
             <p id="noLeaderboardMessageEl" class="text-secondary text-center mt-4" style="display: none;">Leaderboard is empty.</p>
        </section>

        <!-- Notifications Section -->
        <section id="notifications-section" class="section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                 <h2 class="section-title mb-0">Notifications</h2>
                 <button class="btn btn-sm btn-custom btn-custom-secondary" id="markAllReadBtnEl">Mark all as read</button>
            </div>
            <div id="notificationListEl" class="placeholder-glow">
                 <!-- Placeholder for a notification item -->
                 <div class="notification-item placeholder-glow">
                     <div class="notification-icon-container"><span class="placeholder col-8"></span></div>
                     <div class="notification-content flex-grow-1">
                         <span class="placeholder col-6 d-block"></span>
                         <span class="placeholder col-10 d-block mt-1"></span>
                         <span class="placeholder col-4 d-block mt-2"></span>
                     </div>
                 </div>
            </div>
            <p id="noNotificationsMessageEl" class="text-secondary text-center mt-4" style="display: none;">You have no notifications.</p>
        </section>

        <!-- Full Transactions Section -->
        <section id="transactions-section" class="section">
            <h2 class="section-title">All Transactions</h2>
            <div id="fullTransactionsListEl">
                 <!-- Placeholder for a transaction item -->
                 <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div>
            </div>
            <p id="noFullTransactionsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No transactions found.</p>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow"> <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl"> <h3 class="profile-name mt-2" id="profileNameEl"><span class="placeholder col-6"></span></h3> <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p> <div class="profile-stats w-100"> <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div> <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div> <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div> </div> </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"> <span><i class="bi bi-bell-fill"></i> Notifications</span> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked> </div> </label>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span> </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    <div class="modal fade" id="addAmountModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-qr-code-scan me-2"></i> Add Money via QR</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="text-secondary text-center small">1. Scan the QR code to pay.<br>2. Enter amount & Transaction ID below.</p><div class="text-center mb-3"><img src="https://via.placeholder.com/200x200.png?text=Loading+QR..." id="qrCodeImageEl" alt="Payment QR Code" style="max-width: 200px; border-radius: 8px; background: white; padding: 5px;"></div><div class="mb-3"><label for="depositAmountInputEl" class="form-label">Amount Paid (₹)</label><input type="number" class="form-control" id="depositAmountInputEl" placeholder="Enter exact amount you paid"></div><div class="mb-3"><label for="depositTxnIdInputEl" class="form-label">Transaction ID / UTR</label><input type="text" class="form-control" id="depositTxnIdInputEl" placeholder="Enter the 12-digit UTR from payment app"></div><div id="depositStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitDepositRequestBtnEl">Submit Request</button></div></div></div></div>
    <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">₹0.00</strong></p><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min ₹<span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method (UPI/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter UPI ID / Bank Details"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div>
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Room ID & Password</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-secondary">ID/Pass shown shortly before match start.</p><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Room ID:</p><h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Password:</p><h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div><p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p></div></div></div></div>

    <!-- In-Game Name Modal -->
    <div class="modal fade" id="inGameNameModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inGameNameModalTitleEl">Enter In-Game Name</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary small">Please enter your correct In-Game Name/ID for this tournament. This cannot be changed later.</p>
                    <div class="mb-3">
                        <label for="inGameNameInputEl" class="form-label">Your Game ID / Username</label>
                        <input type="text" class="form-control" id="inGameNameInputEl" placeholder="e.g., YourProGamerID" required>
                    </div>
                    <p>Joining for: <strong id="inGameNameFeeEl" class="text-accent">₹0</strong></p>
                    <div id="inGameNameStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="submitJoinWithGameNameBtnEl">Submit & Join</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="leaderboard-section"><i class="bi bi-trophy-fill"></i><span>Leaderboard</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ===============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBQu6IXF2T0F0NbrNYhFHykhGUBIhZb8Dg",
            authDomain: "earning-karo---made-in-india.firebaseapp.com",
            databaseURL: "https://earning-karo---made-in-india-default-rtdb.firebaseio.com",
            projectId: "earning-karo---made-in-india",
            storageBucket: "earning-karo---made-in-india.firebasestorage.app",
            messagingSenderId: "144551856887",
            appId: "1:144551856887:web:ec5b2fb196fcbfa7c861f2",
            measurementId: "G-91YQHMH5L2"
        };
        // ===============================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

        // --- DOM Elements Cache (No Changes) ---
         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), 
             notificationBtn: getElement('notificationBtnEl'),
             notificationBadge: querySel('#notificationBtnEl .notification-badge'),
             loginSection: getElement('login-section'),
             emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             emailSignupForm: getElement('emailSignupForm'), signupEmailInput: getElement('signupEmailInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'),
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             leaderboardSection: getElement('leaderboard-section'), leaderboardList: getElement('leaderboardListEl'), noLeaderboardMessage: getElement('noLeaderboardMessageEl'),
             transactionsSection: getElement('transactions-section'), fullTransactionsList: getElement('fullTransactionsListEl'), noFullTransactionsMessage: getElement('noFullTransactionsMessageEl'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, qrCodeImage: getElement('qrCodeImageEl'), depositAmountInput: getElement('depositAmountInputEl'), depositTxnIdInput: getElement('depositTxnIdInputEl'), submitDepositRequestBtn: getElement('submitDepositRequestBtnEl'), depositStatusMessage: getElement('depositStatusMessageEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             securityWarning: getElement('securityWarning'),
            notificationsSection: getElement('notifications-section'),
            notificationListEl: getElement('notificationListEl'),
            noNotificationsMessageEl: getElement('noNotificationsMessageEl'),
            markAllReadBtnEl: getElement('markAllReadBtnEl'),
            inGameNameModalInstance: getElement('inGameNameModalEl') ? new bootstrap.Modal(getElement('inGameNameModalEl')) : null,
            inGameNameModalTitleEl: getElement('inGameNameModalTitleEl'),
            inGameNameInputEl: getElement('inGameNameInputEl'),
            inGameNameFeeEl: getElement('inGameNameFeeEl'),
            inGameNameStatusMessageEl: getElement('inGameNameStatusMessageEl'),
            submitJoinWithGameNameBtnEl: getElement('submitJoinWithGameNameBtnEl'),
         };

        // --- App State ---
        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let validReferrerUid = null;
        let userDataCache = {}; // Re-initialized on logout
        let previousSectionId = 'home-section'; // For back button logic

        // --- Utility Functions ---
        const showLoader = (show) => { if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none'; };
        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type} mt-3`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        function copyToClipboard(targetSelector) { if (!targetSelector) { alert('Copy target not defined.'); return; } const targetElement = querySel(targetSelector); if (!targetElement) { alert('Element to copy from not found.'); return; } const textToCopy = targetElement.textContent; if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder')) { alert('Nothing to copy.'); return; } navigator.clipboard.writeText(textToCopy).then(() => alert('Copied!')).catch(err => { console.error('Failed to copy:', err); alert('Failed to copy.'); }); }
        function shareReferral(code) { if (!navigator.share) { alert('Web Share not supported. Copy the code manually.'); return; } if (!code || code === 'N/A') { alert('Referral code not available.'); return; } navigator.share({ title: 'Join Me on Gaming Tournament!', text: `Join using my referral code: ${code} & get rewards! App: ${window.location.origin}`, url: window.location.origin }).catch((error) => console.log('Error sharing', error)); }
        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting Soon'; const days = Math.floor(diff / 86400000); const hours = Math.floor((diff % 86400000) / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };
        const formatCurrency = (amount) => `₹${(Number(amount) || 0).toFixed(2)}`;
        const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; };

        // --- UI Functions ---
        function createNotificationElement(id, notif) {
            const item = document.createElement('div');
            item.className = `notification-item ${notif.read ? '' : 'unread'}`;
            item.dataset.id = id;

            let iconClass = 'bi-info-circle-fill'; // Default icon
            switch (notif.type) {
                case 'deposit_approved': case 'prize_win':
                    iconClass = 'bi-check-circle-fill text-success'; break;
                case 'deposit_rejected': case 'withdrawal_rejected':
                    iconClass = 'bi-x-circle-fill text-danger'; break;
                case 'withdrawal_completed':
                    iconClass = 'bi-send-check-fill text-info'; break;
            }

            item.innerHTML = `
                <div class="notification-icon-container"><i class="bi ${iconClass}"></i></div>
                <div class="notification-content">
                    <div class="notification-title">${sanitizeHTML(notif.title)}</div>
                    <div class="notification-body">${sanitizeHTML(notif.body)}</div>
                    <div class="notification-time">${notif.timestamp ? new Date(notif.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short'}) : ''}</div>
                </div>`;

            item.addEventListener('click', () => markNotificationAsRead(id));
            return item;
        }
         function showSection(sectionId, cameFrom) {
             if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
             const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
             const protectedSections = ['home-section', 'wallet-section', 'leaderboard-section', 'profile-section', 'tournaments-section', 'transactions-section', 'notifications-section'];
             const isLoggedIn = !!currentUser;
             if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; }
             if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }

             if (currentSectionId !== sectionId) {
                previousSectionId = cameFrom || currentSectionId;
             }

             elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
             updateHeaderForSection(sectionId);
             elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
             console.log(`Loading data for section: ${sectionId}`);
             switch (sectionId) {
                 case 'home-section': loadHomePageData(); break;
                 case 'wallet-section': loadWalletData(); break;
                 case 'profile-section': loadProfileData(); break;
                 case 'leaderboard-section': loadLeaderboardData(); break;
                 case 'transactions-section': loadFullTransactionHistory(); break;
                 case 'notifications-section': loadNotificationsPage(); break;
                 case 'tournaments-section': if(currentTournamentGameId) { const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming'; filterTournaments(currentTournamentGameId, activeTab); } else { elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>'; } break;
             }
             if (sectionId === 'login-section') { toggleLoginForm(true); }
             window.scrollTo(0, 0);
         }
         function updateHeaderForSection(sectionId) {
             const showBackButton = ['tournaments-section', 'transactions-section', 'notifications-section'].includes(sectionId); 
             const defaultTitleVisible = !showBackButton; 
             const gameTitleVisible = (sectionId === 'tournaments-section');
             
             elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
             elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
             elements.headerGameTitle.style.display = 'none'; // Reset all titles

             let customTitle = '';
             if (gameTitleVisible) {
                customTitle = appSettings?.games?.[currentTournamentGameId]?.name || `Game`; 
             } else if (sectionId === 'transactions-section') {
                customTitle = "History";
             } else if (sectionId === 'notifications-section') {
                customTitle = "Notifications";
             }

             if (customTitle) {
                elements.headerGameTitle.textContent = customTitle;
                elements.headerGameTitle.style.display = 'block';
             } else if (defaultTitleVisible && elements.headerUserGreeting) { 
                const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; 
                elements.headerUserGreeting.textContent = nameToShow; 
             }
         }
         function updateGlobalUI(isLoggedIn) {
             if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; }
             if (elements.notificationBtn) { elements.notificationBtn.style.display = isLoggedIn ? 'block' : 'none'; }
             if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
             if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';
             if (!isLoggedIn && elements.notificationBadge) { elements.notificationBadge.style.display = 'none'; elements.notificationBadge.textContent = '0'; }
             elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none'; });
         }
         function populateUserInfo(user, profile) {
             if (!user || !profile) return;
             const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
             const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
             const balance = (profile.balance || 0); const winningCash = (profile.winningCash || 0); const bonusCash = (profile.bonusCash || 0);
             const totalEarnings = (profile.totalEarnings || 0);
             const totalMatches = profile.totalMatches || 0; const wonMatches = profile.wonMatches || 0;

             if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
             if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(balance);
             if (elements.walletTotalBalance) { elements.walletTotalBalance.textContent = formatCurrency(balance); removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow')); }
             if (elements.walletWinningCash) { elements.walletWinningCash.textContent = formatCurrency(winningCash); removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow')); }
             if (elements.walletBonusCash) { elements.walletBonusCash.textContent = formatCurrency(bonusCash); removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow')); }
             if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash);
             if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
             if (elements.profileName) { elements.profileName.textContent = displayName; removePlaceholders(elements.profileName.closest('.placeholder-glow')); }
             if (elements.profileEmail) { elements.profileEmail.textContent = user.email || 'N/A'; removePlaceholders(elements.profileEmail.closest('.placeholder-glow')); }
             if (elements.profileTotalMatches) { elements.profileTotalMatches.textContent = totalMatches; removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow')); }
             if (elements.profileWonMatches) { elements.profileWonMatches.textContent = wonMatches; removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow')); }
             if (elements.profileTotalEarnings) { elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow')); }
         }
        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm) return;
            clearStatusMessage(elements.loginStatusMessage); clearStatusMessage(elements.signupStatusMessage);
            elements.emailLoginForm.style.display = showLogin ? 'block' : 'none';
            elements.emailSignupForm.style.display = showLogin ? 'none' : 'block';
            elements.emailLoginForm.reset(); elements.emailSignupForm.reset();
        }

        // --- Firebase Auth Functions ---
         async function signUpWithEmail() {
             if (!auth) return;
             const em = elements.signupEmailInput.value.trim(); const pw = elements.signupPasswordInput.value; const cpw = elements.signupConfirmPasswordInput.value; const refCode = elements.signupReferralCodeInput.value.trim();
             if (!em || !pw || !cpw) { showStatusMessage(elements.signupStatusMessage, 'Fill required fields.', 'warning'); return; }
             if (pw !== cpw) { showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning'); return; }
             if (pw.length < 6) { showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning'); return; }
             showLoader(true); clearStatusMessage(elements.signupStatusMessage); validReferrerUid = null;
             try {
                 if (refCode) {
                     const q = query(ref(db, 'users'), orderByChild('referralCode'), equalTo(refCode));
                     const snapshot = await get(q);
                     if (snapshot.exists()) {
                         const referrerData = snapshot.val(); const referrerId = Object.keys(referrerData)[0];
                         if (referrerId && referrerData[referrerId].email) { validReferrerUid = referrerId; console.log("Valid referrer found:", validReferrerUid); }
                         else { console.warn("Referral code found, but referrer data invalid."); }
                     } else { console.log("Referral code not found:", refCode); }
                 }
                 await createUserWithEmailAndPassword(auth, em, pw);
             } catch (e) { console.error("Signup Error:", e); let m = `Signup failed.`; switch (e.code) { case 'auth/email-already-in-use': m = 'Email already registered.'; break; case 'auth/weak-password': m = 'Password too weak.'; break; case 'auth/invalid-email': m = 'Invalid email.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.signupStatusMessage, m, 'danger');
             } finally { showLoader(false); }
         }
         async function loginWithEmail() {
             if (!auth) return;
             const em = elements.loginEmailInput.value.trim(); const pw = elements.loginPasswordInput.value;
             if (!em || !pw) { showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning'); return; }
             showLoader(true); clearStatusMessage(elements.loginStatusMessage);
             try { await signInWithEmailAndPassword(auth, em, pw); }
             catch (e) { console.error("Login Error:", e); let m = `Login failed.`; switch (e.code) { case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
             finally { showLoader(false); }
         }
         async function resetPassword() {
             if (!auth) return;
             const em = elements.loginEmailInput.value.trim();
             if (!em) { showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset.', 'warning'); return; }
             showLoader(true); clearStatusMessage(elements.loginStatusMessage);
             try { await sendPasswordResetEmail(auth, em); showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false); }
             catch (e) { console.error("Reset Pass Error:", e); let m = `Failed to send email.`; switch (e.code) { case 'auth/user-not-found': case 'auth/invalid-email': m = 'Email not found.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
             finally { showLoader(false); }
         }
         async function logoutUser() { if (!auth) return; try { showLoader(true); await signOut(auth); } catch (e) { console.error("Sign Out Error:", e); alert(`Logout failed: ${e.message}`); showLoader(false); } }

        // --- Auth State Change Handler ---
                 async function handleAuthStateChange(user) {
            if (!auth || !db) { console.error("Firebase not ready"); showLoader(false); return; }
            showLoader(true);
            detachAllDbListeners();
            currentUser = user;
            const localReferrerUid = validReferrerUid; // Capture referrer UID before resetting
            validReferrerUid = null;

            if (user) {
                console.log("Auth State: Logged In", user.uid);
                const userRef = ref(db, 'users/' + user.uid);
                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        userProfile = snapshot.val();
                        if (userProfile.status === 'blocked') {
                            alert("Your account has been blocked. Please contact support.");
                            await logoutUser();
                            return;
                        }
                    } else {
                        console.log("New user, creating profile...");
                        const newUserProfile = {
                            uid: user.uid,
                            displayName: user.displayName || user.email?.split('@')[0] || 'User',
                            email: user.email,
                            balance: appSettings.newUserBalance || 0,
                            winningCash: 0,
                            bonusCash: appSettings.newUserBonus || 0,
                            createdAt: serverTimestamp(),
                            referralCode: generateReferralCode(),
                            status: 'active',
                            totalEarnings: 0
                        };
                        
                        // IMPORTANT: Add referrer info only if it exists
                        if (localReferrerUid) {
                            newUserProfile.referredBy = localReferrerUid;
                        }

                        // Write the new user's profile ONLY.
                        await set(userRef, newUserProfile);
                        userProfile = newUserProfile;

                        // Record welcome bonus for the new user.
                        if (newUserProfile.bonusCash > 0) {
                            await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`);
                        }
                        
                        // NOTE: Referral bonus logic is insecure here and has been removed. 
                        // It should be handled by a server-side Cloud Function for security.
                        if (localReferrerUid) {
                             console.log(`User was referred by ${localReferrerUid}, but bonus logic must be on the server.`);
                        }
                    }
                    
                    userDataCache[user.uid] = { displayName: userProfile.displayName, email: userProfile.email, photoURL: userProfile.photoURL };
                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);
                    const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                    showSection(targetSection);

                } catch (error) {
                    console.error("Profile handling error:", error);
                    alert("Error loading profile. Logging out. " + error.message);
                    try { await logoutUser(); } catch (logoutErr) {}
                }
            } else {
                console.log("Auth State: Logged Out");
                currentUser = null;
                userProfile = {};
                userDataCache = {};
                updateGlobalUI(false);
                showSection('login-section');
            }
            showLoader(false);
        }

        // --- अपने यूज़र ऐप में इस पूरे फंक्शन को बदलें ---
        
        async function loadNotificationsPage() {
        if (!currentUser || !elements.notificationListEl) return;
        elements.notificationListEl.innerHTML = '';
        elements.notificationListEl.classList.add('placeholder-glow');
        for (let i = 0; i < 4; i++) {
        elements.notificationListEl.innerHTML += `<div class="notification-item placeholder-glow"><div class="notification-icon-container"><span class="placeholder col-8"></span></div><div class="notification-content flex-grow-1"><span class="placeholder col-6 d-block"></span><span class="placeholder col-10 d-block mt-1"></span><span class="placeholder col-4 d-block mt-2"></span></div></div>`;
        }
        elements.noNotificationsMessageEl.style.display = 'none';
        
        try {
        const q = query(ref(db, `notifications/${currentUser.uid}`), orderByChild('timestamp'));
        const s = await get(q);
        removePlaceholders(elements.notificationListEl);
        elements.notificationListEl.innerHTML = '';
        
        if (s.exists()) {
        const notifications = [];
        s.forEach(child => {
        const notifData = child.val();
        // --- सबसे ज़रूरी लाइन: सिर्फ उन्हीं नोटिफिकेशन को जोड़ें जिनमें title और body हो ---
        if (notifData && notifData.title && notifData.body) {
        notifications.push({ id: child.key, ...notifData });
        } else {
        console.warn("Skipping malformed notification:", child.key, notifData);
        }
        });
        
        // अब हमारे पास सिर्फ सही नोटिफिकेशन हैं
        notifications.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Sort descending
        
        if (notifications.length > 0) {
        notifications.forEach(notif => {
        const el = createNotificationElement(notif.id, notif);
        elements.notificationListEl.appendChild(el);
        });
        } else {
        // अगर सही नोटिफिकेशन एक भी नहीं मिलीं
        elements.noNotificationsMessageEl.style.display = 'block';
        }
        
        } else {
        elements.noNotificationsMessageEl.style.display = 'block';
        }
        } catch (e) {
        console.error("Failed to load notifications:", e);
        removePlaceholders(elements.notificationListEl);
        elements.notificationListEl.innerHTML = '<p class="text-danger text-center">Could not load notifications.</p>';
        }
        }

        async function markNotificationAsRead(notifId) {
            if (!currentUser || !notifId) return;
            const notifRef = ref(db, `notifications/${currentUser.uid}/${notifId}`);
            await update(notifRef, { read: true });
            // UI will update automatically via the realtime listener
        }
        
        async function markAllNotificationsAsRead() {
            if (!currentUser) return;
            showLoader(true);
            try {
                const q = query(ref(db, `notifications/${currentUser.uid}`), orderByChild('read'), equalTo(false));
                const s = await get(q);
                if (s.exists()) {
                    const updates = {};
                    s.forEach(child => {
                        updates[`${child.key}/read`] = true;
                    });
                    await update(ref(db, `notifications/${currentUser.uid}`), updates);
                }
            } catch (e) {
                console.error("Error marking all as read:", e);
                alert("Could not mark all notifications as read.");
            } finally {
                showLoader(false);
            }
        }
        async function loadAppSettings() { console.log("Loading App Settings..."); try { const snapshot = await get(ref(db, 'settings')); if (snapshot.exists()) { appSettings = snapshot.val() || {}; console.log("App Settings Loaded:", appSettings); if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl; if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw; if (appSettings.qrCodeUrl && elements.qrCodeImage) { elements.qrCodeImage.src = appSettings.qrCodeUrl; } else if (elements.qrCodeImage) { elements.qrCodeImage.src = 'https://via.placeholder.com/200x200.png?text=QR+Not+Set'; } } else { console.warn("App Settings not found in database!"); appSettings = {}; } } catch (e) { console.error("Settings load failed", e); appSettings = {}; } }
        function loadHomePageData() { if (!currentUser) { if(elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = ''; if(elements.gamesList) elements.gamesList.innerHTML = ''; if(elements.myContestsList) elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>'; return; } loadPromotions(); loadGames(); loadMyContests(); }
        async function loadPromotions() { const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper'); if (!sliderWrapper) return; sliderWrapper.classList.add('placeholder-glow'); sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`; try { const s = await get(ref(db, 'promotions')); const p = Object.values(s.val() || {}).filter(p => p.imageUrl); removePlaceholders(elements.promotionSlider); sliderWrapper.innerHTML = ''; if (p.length > 0) { elements.promotionSlider.style.display = 'block'; p.forEach(promo => { const slide = document.createElement('div'); slide.className = 'swiper-slide'; slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`; sliderWrapper.appendChild(slide); }); if (swiperInstance) swiperInstance.destroy(true, true); swiperInstance = new Swiper(elements.promotionSlider, { loop: p.length > 1, autoplay: { delay: 3500 }, pagination: { el: '.swiper-pagination', clickable: true } }); } else { elements.promotionSlider.style.display = 'none'; } } catch (e) { console.error("Promo load failed:", e); removePlaceholders(elements.promotionSlider); sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>'; } }
        async function loadGames() { if (!elements.gamesList) return; elements.gamesList.classList.add('placeholder-glow'); elements.gamesList.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto"></span></div></div><div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto"></span></div></div>`; try { const s = await get(ref(db, 'games')); const g = Object.entries(s.val() || {}).filter(([, game]) => game.imageUrl && game.name).sort(([, a], [, b]) => (a.order || 0) - (b.order || 0)); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = ''; if (g.length > 0) { if (!appSettings.games) appSettings.games = {}; g.forEach(([id, game]) => { appSettings.games[id] = { name: game.name }; const col = document.createElement('div'); col.className = 'col-6'; col.innerHTML = `<div class="game-card custom-card" data-game-id="${id}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`; col.querySelector('.game-card').onclick = () => { currentTournamentGameId = id; loadTournamentsForGame(id, game.name); }; elements.gamesList.appendChild(col); }); } else { elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>'; } } catch (e) { console.error("Games load failed:", e); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>'; } }
        function loadTournamentsForGame(gameId, gameName) { currentTournamentGameId = gameId; elements.tournamentTabs.forEach(t => t.classList.remove('active')); querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active'); showSection('tournaments-section'); }
        async function filterTournaments(gameId, status) {
            if (!elements.tournamentsListContainer) return;
            elements.tournamentsListContainer.innerHTML = '';
            elements.tournamentsListContainer.classList.add('placeholder-glow');
            elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><div class="tournament-content-wrapper"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div></div>`;
            elements.noTournamentsMessage.style.display = 'none';
            try {
                const q = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId));
                const s = await get(q);
                let relevantStatuses = [status];
                if (status === 'completed') relevantStatuses.push('result');

                const fT = Object.entries(s.val() || {}).filter(([, t]) => relevantStatuses.includes(t.status)).sort(([, a], [, b]) => (a.startTime || 0) - (b.startTime || 0));
                
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '';

                if (fT.length > 0) {
                    for (const [id, t] of fT) {
                        const cardElement = await createTournamentCardElement(id, t);
                        elements.tournamentsListContainer.appendChild(cardElement);
                    }
                } else {
                    elements.noTournamentsMessage.style.display = 'block';
                    elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
                }
            } catch (e) {
                console.error(`Tournaments filter failed (${status}):`, e);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>';
            }
        }
        
        async function createTournamentCardElement(tId, t) {
            const card = document.createElement('div');
            card.className = 'tournament-card';
            card.dataset.tournamentId = tId;

            const eFee = t.entryFee || 0;
            const sTime = t.startTime ? new Date(t.startTime) : null;
            const sTimeLoc = sTime ? sTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA';
            const regC = Object.keys(t.registeredPlayers || {}).length;
            const maxP = t.maxPlayers || 0;
            const spotsL = maxP > 0 ? Math.max(0, maxP - regC) : Infinity;
            const isF = maxP > 0 && spotsL <= 0;
            const isJ = currentUser && userProfile?.joinedTournaments?.[tId];
            const canJ = !isJ && !isF && t.status === 'upcoming';

            let timerTxt = t.status?.toUpperCase() || 'N/A';
            if (t.status === 'upcoming' && sTime) timerTxt = getTimeRemaining(t.startTime);
            else if (t.status === 'ongoing') timerTxt = 'LIVE';
            else if (t.status === 'completed' || t.status === 'result') timerTxt = 'ENDED';

            let spotsTxt = 'Unlimited Spots';
            let progP = 0;
            if (maxP > 0) {
                spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Spots Left (${regC}/${maxP})`;
                progP = Math.min(100, (regC / maxP) * 100);
            }

            let mainContent = '';
            if (t.status === 'result' && t.results && Array.isArray(t.results)) {
                const winnerUids = t.results.map(w => w.uid).filter(uid => !userDataCache[uid]);
                if (winnerUids.length > 0) {
                    const userPromises = winnerUids.map(uid => get(ref(db, `users/${uid}`)));
                    const userSnaps = await Promise.all(userPromises);
                    userSnaps.forEach(snap => {
                        if (snap.exists()) {
                            const u = snap.val();
                            userDataCache[snap.key] = { displayName: u.displayName, email: u.email, photoURL: u.photoURL };
                        }
                    });
                }

                let tableRows = '';
                t.results.sort((a,b) => a.rank - b.rank).forEach(winner => {
                    const isCurrentUser = currentUser && winner.uid === currentUser.uid;
                    const highlightClass = isCurrentUser ? 'user-highlight' : '';
                    const winnerName = userDataCache[winner.uid]?.displayName || 'Player..';
                    
                    tableRows += `<tr class="${highlightClass}">
                        <td>#${winner.rank}</td>
                        <td>${sanitizeHTML(winnerName)}</td>
                        <td>${winner.kills}</td>
                        <td class="text-success">${formatCurrency(winner.prize)}</td>
                    </tr>`;
                });
                
                mainContent = `<div class="results-table-container">
                    <h5 class="section-title" style="font-size: 1rem; margin-bottom: 10px;">🏆 Winners List</h5>
                    <table class="results-table">
                        <thead><tr><th>Rank</th><th>Player</th><th>Kills</th><th>Prize</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>`;

            } else if (t.status === 'completed' || t.status === 'result') {
                 mainContent = `<div class="text-center p-3 text-secondary">Results will be declared soon.</div>`;
            } else {
                let actBtn = '';
                let idPassBtn = '';

                if (isJ) {
                    actBtn = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
                    if ((t.status === 'ongoing' || t.status === 'upcoming') && t.showIdPass) {
                        idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                    }
                } else if (canJ) {
                    actBtn = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${eFee}">₹${eFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
                } else {
                    let disR = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed');
                    actBtn = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disR || 'N/A'}</button>`;
                }

                mainContent = `
                    <div class="tournament-card-info">
                        <div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ${formatCurrency(t.prizePool)}</strong></div>
                        <div class="info-item"><span>Per Kill</span><strong>${formatCurrency(t.perKillPrize)}</strong></div>
                        <div class="info-item"><span>Entry Fee</span><strong class="${eFee > 0 ? 'text-info' : ''}">${eFee > 0 ? formatCurrency(eFee) : 'Free'}</strong></div>
                    </div>
                    <div class="tournament-card-spots">${spotsTxt}${maxP > 0 ? `<div class="progress mt-1"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}</div>
                    
                    <div class="tournament-card-actions">
                        <button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}">Details</button>
                        ${actBtn}
                    </div>
                    ${idPassBtn}`;
            }

            const tournamentIcon = t.icon || 'bi-joystick';
            
            let bannerHtml = '';
            if (t.bannerUrl) {
                bannerHtml = `<img src="${sanitizeHTML(t.bannerUrl)}" alt="${sanitizeHTML(t.name)} Banner" class="tournament-banner-img">`;
            }

            card.innerHTML = `
                ${bannerHtml}
                <div class="tournament-content-wrapper">
                    <div class="tournament-card-header">
                        <div class="tournament-card-tags">${(t.tags || []).map(tag => `<span>${sanitizeHTML(tag)}</span>`).join('')}</div>
                        <div class="tournament-card-timer">${timerTxt}</div>
                    </div>
                    <h3 class="tournament-card-title"><i class="bi ${tournamentIcon} text-accent"></i> ${sanitizeHTML(t.name) || 'Tournament'}</h3>
                    <p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p>
                    ${mainContent}
                </div>`;
            
            card.querySelector('.btn-join')?.addEventListener('click', handleJoinTournamentClick);
            card.querySelector('.btn-details')?.addEventListener('click', handleMatchDetailsClick);
            card.querySelector('.btn-idpass')?.addEventListener('click', handleIdPasswordClick);
            return card;
        }

        async function loadMyContests() { if (!currentUser || !elements.myContestsList) { if(elements.myContestsList) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; } if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; } const joinedIds = Object.keys(userProfile.joinedTournaments || {}); elements.myContestsList.classList.add('placeholder-glow'); elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><div class="tournament-content-wrapper"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div></div>`; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none'; if (joinedIds.length === 0) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; } try { const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`))); const snapshots = await Promise.all(contestPromises); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; const contestCards = []; for (const [i, s] of snapshots.entries()) { if (s.exists()) { const t = s.val(); if (t.status === 'upcoming' || t.status === 'ongoing') { const cardEl = await createTournamentCardElement(joinedIds[i], t); contestCards.push({ startTime: t.startTime || 0, card: cardEl }); } } } contestCards.sort((a, b) => a.startTime - b.startTime); if (contestCards.length > 0) { contestCards.forEach(item => elements.myContestsList.appendChild(item.card)); } else if (elements.noContestsMessage) { elements.noContestsMessage.style.display = 'block'; elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests."; } } catch (e) { console.error("My contests load failed:", e); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>'; } }
        function loadWalletData() { if (!currentUser) return; loadRecentTransactions(); }
        function loadProfileData() { if (!currentUser) return; if (userProfile?.displayName) { removePlaceholders(elements.profileName?.closest('.placeholder-glow')); removePlaceholders(elements.profileEmail?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileWonMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalEarnings?.closest('.placeholder-glow')); } }
        async function recordTransaction(userId, type, amount, description, details = {}) { if (!userId) return; const newTransaction = { type, amount, description, timestamp: serverTimestamp(), ...details }; try { await push(ref(db, `transactions/${userId}`), newTransaction); } catch (e) { console.error("Transaction record failed:", e); } }
        async function loadRecentTransactions() { if (!currentUser || !elements.recentTransactionsList) return; const limit = 5; elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow'); for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5"></span><span class="placeholder col-3"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6"></span></div></div>`; if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading...'; } try { const s = await get(query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit))); const sortedT = Object.values(s.val() || {}).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = ''; if (sortedT.length > 0) { if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; sortedT.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}₹${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'; item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.recentTransactionsList.appendChild(item); }); } else if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'No recent transactions.'; } } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; } }
        async function loadFullTransactionHistory() { if (!currentUser || !elements.fullTransactionsList) return; elements.fullTransactionsList.innerHTML = ''; elements.fullTransactionsList.classList.add('placeholder-glow'); for (let i = 0; i < 5; i++) elements.fullTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5"></span><span class="placeholder col-3"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6"></span></div></div>`; if (elements.noFullTransactionsMessage) elements.noFullTransactionsMessage.style.display = 'none'; try { const q = query(ref(db, `transactions/${currentUser.uid}`), orderByChild('timestamp')); const s = await get(q); const transactions = Object.values(s.val() || {}).sort((a, b) => b.timestamp - a.timestamp); removePlaceholders(elements.fullTransactionsList); elements.fullTransactionsList.innerHTML = ''; if (transactions.length > 0) { elements.noFullTransactionsMessage.style.display = 'none'; transactions.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-3 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}₹${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString() : 'N/A'; item.innerHTML = `<div><div class="fw-bold">${t.description || t.type}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.fullTransactionsList.appendChild(item); }); } else if (elements.noFullTransactionsMessage) { elements.noFullTransactionsMessage.style.display = 'block'; } } catch (e) { console.error("Full transactions load failed:", e); removePlaceholders(elements.fullTransactionsList); elements.fullTransactionsList.innerHTML = '<p class="text-danger text-center">Could not load history.</p>'; } }
        async function loadLeaderboardData() { if (!currentUser || !elements.leaderboardList) return; elements.leaderboardList.innerHTML = ''; elements.leaderboardList.classList.add('placeholder-glow'); for (let i = 0; i < 5; i++) elements.leaderboardList.innerHTML += `<div class="leaderboard-item placeholder-glow"><span class="leaderboard-rank placeholder col-1"></span><span class="placeholder leaderboard-avatar" style="width: 45px; height: 45px; border-radius: 50%;"></span><div class="leaderboard-info flex-grow-1"><span class="placeholder col-5"></span></div><span class="leaderboard-winnings placeholder col-3"></span></div>`; if (elements.noLeaderboardMessage) elements.noLeaderboardMessage.style.display = 'none'; try { const q = query(ref(db, 'users'), orderByChild('totalEarnings'), limitToLast(10)); const s = await get(q); if (!s.exists()) { elements.noLeaderboardMessage.style.display = 'block'; removePlaceholders(elements.leaderboardList); elements.leaderboardList.innerHTML = ''; return; } const topUsers = Object.values(s.val() || {}).sort((a, b) => (b.totalEarnings || 0) - (a.totalEarnings || 0)); removePlaceholders(elements.leaderboardList); elements.leaderboardList.innerHTML = ''; if (topUsers.length > 0) { elements.noLeaderboardMessage.style.display = 'none'; topUsers.forEach((user, index) => { const isCurrentUser = user.uid === currentUser.uid; const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'P')}&background=1E293B&color=E2E8F0&bold=true&size=45`; const item = document.createElement('div'); item.className = `leaderboard-item ${isCurrentUser ? 'user-highlight' : ''}`; item.innerHTML = `<span class="leaderboard-rank">#${index + 1}</span><img src="${photoURL}" alt="Avatar" class="leaderboard-avatar"><div class="leaderboard-info"><div class="leaderboard-name">${sanitizeHTML(user.displayName || 'Player')}</div></div><div class="leaderboard-winnings">${formatCurrency(user.totalEarnings)}</div>`; elements.leaderboardList.appendChild(item); }); } else { elements.noLeaderboardMessage.style.display = 'block'; } } catch (e) { console.error("Leaderboard load failed:", e); removePlaceholders(elements.leaderboardList); elements.leaderboardList.innerHTML = '<p class="text-danger text-center">Could not load leaderboard.</p>'; } }

        async function handleJoinTournamentClick(event) {
            if (!currentUser) {
                alert("Login to join.");
                showSection('login-section');
                return;
            }
            const btn = event.currentTarget;
            const tId = btn.dataset.tournamentId;
            const fee = parseFloat(btn.dataset.fee || 0);
            const tournamentName = btn.closest('.tournament-content-wrapper').querySelector('.tournament-card-title').textContent.trim();
            if (!tId) return;

            const modal = elements.inGameNameModalInstance;
            if (modal) {
                elements.inGameNameModalTitleEl.textContent = `Join: ${tournamentName}`;
                elements.inGameNameFeeEl.textContent = formatCurrency(fee);
                elements.inGameNameInputEl.value = userProfile.inGameNames?.[currentTournamentGameId] || ''; 
                clearStatusMessage(elements.inGameNameStatusMessageEl);

                elements.submitJoinWithGameNameBtnEl.replaceWith(elements.submitJoinWithGameNameBtnEl.cloneNode(true));
                const newSubmitBtn = getElement('submitJoinWithGameNameBtnEl');

                newSubmitBtn.onclick = () => {
                    const inGameName = elements.inGameNameInputEl.value.trim();
                    if (!inGameName) {
                        showStatusMessage(elements.inGameNameStatusMessageEl, 'In-Game Name is required.', 'warning');
                        return;
                    }
                    processTournamentJoin(btn, tId, fee, inGameName);
                };
                
                modal.show();
            }
        }
        
        // --- पूरी तरह से बदला हुआ और सही किया गया फंक्शन ---
        async function processTournamentJoin(originalJoinButton, tId, fee, inGameName) {
            const submitBtn = elements.submitJoinWithGameNameBtnEl;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';
            
            originalJoinButton.disabled = true; 
            originalJoinButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            const uRef = ref(db, `users/${currentUser.uid}`);

            try {
                // Step 1: सबसे पहले यूजर और टूर्नामेंट की ताज़ा जानकारी एक साथ हासिल करें
                const userSnap = await get(uRef);
                const tournamentSnap = await get(ref(db, `tournaments/${tId}`));

                if (!userSnap.exists()) throw new Error("User profile not found.");
                if (!tournamentSnap.exists()) throw new Error("Tournament not found.");
                
                const currentProfile = userSnap.val();
                const tournamentData = tournamentSnap.val();

                // Step 2: क्लाइंट-साइड पर सभी शर्तों की जाँच करें
                if ((currentProfile.balance || 0) < fee) throw new Error("Insufficient balance.");
                if (currentProfile.joinedTournaments?.[tId]) throw new Error("You have already joined this tournament.");
                if (tournamentData.status !== 'upcoming') throw new Error("This tournament is no longer open for registration.");
                if (tournamentData.maxPlayers > 0 && Object.keys(tournamentData.registeredPlayers || {}).length >= tournamentData.maxPlayers) throw new Error("This tournament is full.");
                
                // Step 3: सभी अपडेट्स को एक ऑब्जेक्ट में तैयार करें
                const newBalance = (currentProfile.balance || 0) - fee;
                const newTransactionRef = push(ref(db, `transactions/${currentUser.uid}`)); // नया ट्रांजैक्शन आईडी बनाएं

                const updates = {};
                // यूजर की प्रोफाइल अपडेट करें
                updates[`users/${currentUser.uid}/balance`] = newBalance;
                updates[`users/${currentUser.uid}/joinedTournaments/${tId}`] = { joinedAt: serverTimestamp() };
                updates[`users/${currentUser.uid}/inGameNames/${currentTournamentGameId}`] = inGameName;
                
                // टूर्नामेंट में यूजर को रजिस्टर करें
                updates[`tournaments/${tId}/registeredPlayers/${currentUser.uid}`] = {
                    inGameName: inGameName,
                    joinedAt: serverTimestamp()
                };

                // ट्रांजैक्शन रिकॉर्ड करें
                updates[`transactions/${currentUser.uid}/${newTransactionRef.key}`] = {
                    type: 'tournament_join',
                    amount: -fee,
                    description: `Joined: ${tournamentData.name || 'Tournament'}`,
                    timestamp: serverTimestamp(),
                    details: { tournamentId: tId }
                };

                // Step 4: सभी अपडेट्स को एक साथ, एक ही बार में भेजें
                await update(ref(db), updates);

                // Step 5: सफल होने पर UI अपडेट करें
                elements.inGameNameModalInstance.hide();
                alert(`Joined successfully! ${formatCurrency(fee)} deducted.`);

                // UI को ताज़ा करें
                const finalTournamentState = (await get(ref(db, `tournaments/${tId}`))).val();
                if (finalTournamentState) {
                    const cardEl = originalJoinButton.closest('.tournament-card');
                    if (cardEl) {
                        cardEl.parentNode.replaceChild(await createTournamentCardElement(tId, finalTournamentState), cardEl);
                    }
                }
                if (currentSectionId === 'home-section') loadMyContests();
                
            } catch (e) {
                console.error("Join failed:", e);
                let userMessage = e.message;
                if (e.message?.includes("PERMISSION_DENIED")) {
                    userMessage = "Could not register due to a server permission error. Please contact support.";
                }
                showStatusMessage(elements.inGameNameStatusMessageEl, `Failed: ${userMessage}`, 'danger', false);

            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit & Join';
                // बटन को फिर से एनेबल करें ताकि यूजर दोबारा कोशिश कर सके
                originalJoinButton.disabled = false;
                originalJoinButton.innerHTML = `₹${fee} Join <i class="bi bi-arrow-right-short"></i>`;
            }
        }

        // --- Modal Handlers ---
        async function handleSubmitDepositRequest() { if (!currentUser) { alert("Please login first."); return; } const amount = parseFloat(elements.depositAmountInput.value); const txnId = elements.depositTxnIdInput.value.trim(); if (isNaN(amount) || amount <= 0) { showStatusMessage(elements.depositStatusMessage, 'Please enter a valid amount.', 'warning'); return; } if (!txnId) { showStatusMessage(elements.depositStatusMessage, 'Please enter the Transaction ID.', 'warning'); return; } elements.submitDepositRequestBtn.disabled = true; elements.submitDepositRequestBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Submitting...`; try { const requestData = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amount, transactionId: txnId, status: 'pending', requestTimestamp: serverTimestamp() }; await push(ref(db, 'depositRequests'), requestData); showStatusMessage(elements.depositStatusMessage, 'Request submitted successfully! Admin will verify and update your balance.', 'success', false); elements.depositAmountInput.value = ''; elements.depositTxnIdInput.value = ''; setTimeout(() => { if (elements.addAmountModalInstance) { elements.addAmountModalInstance.hide(); clearStatusMessage(elements.depositStatusMessage); } }, 3000); } catch (error) { console.error("Deposit request failed:", error); showStatusMessage(elements.depositStatusMessage, 'Failed to submit request. Please try again.', 'danger'); } finally { elements.submitDepositRequestBtn.disabled = false; elements.submitDepositRequestBtn.innerHTML = 'Submit Request'; } }
        function handleWithdrawClick() { if (!currentUser || !elements.withdrawModalInstance) return; const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; elements.minWithdrawAmount.textContent = minW; elements.withdrawModalBalance.textContent = `₹${wc.toFixed(2)}`; elements.withdrawAmountInput.value = ''; elements.withdrawAmountInput.min = minW; elements.withdrawMethodInput.value = userProfile.upiId || ''; clearStatusMessage(elements.withdrawStatusMessage); elements.withdrawModalInstance.show(); }
        async function submitWithdrawRequestHandler() { if (!currentUser || !elements.withdrawModalInstance) return; const amt = parseFloat(elements.withdrawAmountInput.value); const mtd = elements.withdrawMethodInput.value.trim(); const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; clearStatusMessage(elements.withdrawStatusMessage); if (isNaN(amt) || amt <= 0 || amt < minW || amt > wc) { showStatusMessage(elements.withdrawStatusMessage, `Invalid amount. Must be between ₹${minW} and ₹${wc.toFixed(2)}.`, 'warning'); return; } if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; } elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; let txCommitted = false; try { const txResult = await runTransaction(ref(db, `users/${currentUser.uid}`), (prof) => { if (prof) { if ((prof.winningCash || 0) >= amt) { prof.balance -= amt; prof.winningCash -= amt; return prof; } else { throw new Error("Insufficient winning balance."); } } else { throw new Error("Profile missing."); } }); if (!txResult.committed) throw new Error("Failed to update balance."); txCommitted = true; const newReq = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amt, methodDetails: { accountInfo: mtd }, status: 'pending', requestTimestamp: serverTimestamp(), userEmail: currentUser.email }; const newRef = await push(ref(db, 'withdrawals'), newReq); await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newRef.key }); showStatusMessage(elements.withdrawStatusMessage, 'Request submitted!', 'success', false); setTimeout(() => { elements.withdrawModalInstance?.hide(); }, 2500); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } catch (e) { console.error("Withdraw error:", e); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger'); if (txCommitted) { console.warn("Attempting to refund balance..."); try { await runTransaction(ref(db, `users/${currentUser.uid}`), (prof) => { if (prof) { prof.balance = (prof.balance || 0) + amt; prof.winningCash = (prof.winningCash || 0) + amt; } return prof; }); await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal`); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger'); } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND!", refundError); showStatusMessage(elements.withdrawStatusMessage, `Error. CRITICAL: Failed to refund! Contact support.`, 'danger', false); } } } finally { elements.submitWithdrawRequestBtn.disabled = false; elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request'; } }
        async function handleMatchDetailsClick(event) {
            if (!elements.matchDetailsModalInstance) return;
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;
            elements.matchDetailsModalTitle.textContent = 'Loading...';
            elements.matchDetailsModalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.matchDetailsModalInstance.show();
            try {
                const s = await get(ref(db, `tournaments/${tId}`));
                if (s.exists()) {
                    const t = s.val();
                    const gName = appSettings.games?.[t.gameId]?.name || 'N/A';
                    const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short'}) : 'TBA';
                    
                    let pDistHTML = '';
                    if (t.prizeDistribution) {
                        let fmtDist = typeof t.prizeDistribution === 'object' ? Object.entries(t.prizeDistribution).map(([r, p]) => `Rank ${r}: ₹${p}`).join('\n') : String(t.prizeDistribution);
                        pDistHTML = `<h5>Prize Distribution:</h5><pre>${fmtDist}</pre>`;
                    }

                    let participantsHTML = '';
                    const registeredPlayers = t.registeredPlayers || {};
                    const participantCount = Object.keys(registeredPlayers).length;
                    if (participantCount > 0) {
                        const playerNames = Object.values(registeredPlayers)
                                                 .map(player => sanitizeHTML(player.inGameName))
                                                 .join('\n');
                        participantsHTML = `<h5>Participants (${participantCount}):</h5><pre>${playerNames}</pre>`;
                    } else {
                        participantsHTML = `<h5>Participants (0):</h5><pre>Be the first to join!</pre>`;
                    }

                    const desc = (t.description || 'Standard rules apply.').replace(/\n/g, '<br>');
                    elements.matchDetailsModalTitle.textContent = t.name || 'Match Details';
                    elements.matchDetailsModalBody.innerHTML = `
                        <p><strong>Game:</strong> ${gName}</p><p><strong>Starts:</strong> ${sTimeLoc}</p><hr>
                        <p><strong>Entry:</strong> ${t.entryFee > 0 ? `₹${t.entryFee}` : 'Free'}</p>
                        <p><strong>Prize:</strong> ₹${t.prizePool || 0}</p>
                        <p><strong>Per Kill:</strong> ₹${t.perKillPrize || 0}</p><hr>
                        <h5>Match Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${desc}</div>
                        ${participantsHTML}
                        ${pDistHTML}`;
                } else {
                    elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>';
                }
            } catch (e) {
                console.error("Details load failed:", e);
                elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>';
            }
        }
        async function handleIdPasswordClick(event) { if (!elements.idPasswordModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return; if (!currentUser || !userProfile?.joinedTournaments?.[tId]) { alert("Join the tournament first."); return; } elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.idPasswordModalInstance.show(); try { const s = await get(ref(db, `tournaments/${tId}`)); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow')); if (s.exists()) { const tData = s.val(); if (tData.showIdPass) { elements.roomIdDisplay.textContent = tData.roomId || 'Not updated yet'; elements.roomPasswordDisplay.textContent = tData.roomPassword || 'Not updated yet'; } else { elements.roomIdDisplay.textContent = 'Hidden by Admin'; elements.roomPasswordDisplay.textContent = 'Hidden by Admin'; } } else { elements.roomIdDisplay.textContent = 'Not Found'; elements.roomPasswordDisplay.textContent = 'Not Found'; } } catch (e) { console.error("ID/Pass fetch error:", e); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); elements.roomIdDisplay.textContent = 'Error'; elements.roomPasswordDisplay.textContent = 'Error'; } }
        async function handlePolicyClick(event) { if (!elements.policyModalInstance) return; event.preventDefault(); const policyType = event.currentTarget.dataset.policy; if (!policyType) return; let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border"></div></div>'; elements.policyModalBody.innerHTML = modalBodyContent; switch (policyType) { case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'N/A'; break; case 'terms': title = 'Terms & Conditions'; modalBodyContent = appSettings.policyTerms || 'N/A'; break; case 'refund': title = 'Refund Policy'; modalBodyContent = appSettings.policyRefund || 'N/A'; break; case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'N/A'; break; case 'refer': title = 'Refer & Earn'; if (!currentUser) { alert("Login to view referral."); return; } const code = userProfile.referralCode || 'N/A'; const bonus = appSettings?.referralBonus || 0; const desc = appSettings?.referralDescription || `Get ₹${bonus} when your friend joins!`; modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><div class="my-4 p-3" style="background:var(--primary-bg);border-radius:8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${code}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${desc}</p></div>`; break; default: title = 'Info'; modalBodyContent = '<p>Unavailable.</p>'; } elements.policyModalTitle.textContent = title; if (typeof modalBodyContent === 'string' && policyType !== 'refer') { elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>'); } else { elements.policyModalBody.innerHTML = modalBodyContent; } elements.policyModalInstance.show(); }

        // --- Realtime Listeners ---
        function setupRealtimeListeners(uid) {
            if (!uid || !db || !currentUser) return;
            detachAllDbListeners();
            
            // User profile listener
            const uRef = ref(db, `users/${uid}`);
            const userListener = onValue(uRef, (s) => {
                if (currentUser && currentUser.uid === uid) {
                    if (s.exists()) {
                        userProfile = s.val();
                        userDataCache[uid] = { displayName: userProfile.displayName, email: userProfile.email };
                        populateUserInfo(currentUser, userProfile);
                        if (currentSectionId === 'home-section') loadMyContests();
                        if (currentSectionId === 'wallet-section') loadRecentTransactions();
                    } else {
                        alert("Account data missing. Logging out.");
                        logoutUser();
                    }
                } else {
                    off(uRef, 'value', userListener);
                }
            }, (e) => { console.error("Listener error (user profile):", e); });
            dbListeners['userProfile'] = { path: `users/${uid}`, func: userListener };

            // Notifications listener
            const notifRef = query(ref(db, `notifications/${uid}`), orderByChild('read'), equalTo(false));
            const notifListener = onValue(notifRef, (s) => {
                if (currentUser && currentUser.uid === uid) {
                    const count = s.exists() ? s.size : 0;
                    if (elements.notificationBadge) {
                        elements.notificationBadge.textContent = count > 9 ? '9+' : count;
                        elements.notificationBadge.style.display = count > 0 ? 'flex' : 'none';
                    }
                    if (currentSectionId === 'notifications-section' && document.visibilityState === 'visible') {
                        loadNotificationsPage(); // Refresh the list if user is on the page
                    }
                } else {
                    off(notifRef, 'value', notifListener);
                }
            }, (e) => { console.error("Listener error (notifications):", e); });
            dbListeners['notifications'] = { path: `notifications/${uid}`, func: notifListener };
        }
        function detachAllDbListeners() { for (const k in dbListeners) { try { const { path, func } = dbListeners[k]; if (path && func) off(ref(db, path), 'value', func); } catch (e) { console.error(`Detach error ${k}:`, e); } } dbListeners = {}; }

        // --- Event Listeners Initialization ---
        function initializeEventListeners() {
            elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); }));
            elements.headerBackBtn?.addEventListener('click', () => showSection(previousSectionId || 'home-section'));
            elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (currentTournamentGameId && s) { elements.tournamentTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); filterTournaments(currentTournamentGameId, s); } }));
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
            elements.notificationSwitch?.addEventListener('change', (e) => console.log("Notification toggle:", e.target.checked));
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', () => { if (currentUser) elements.addAmountModalInstance?.show(); else { alert("Login first."); showSection('login-section'); } });
            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            elements.submitDepositRequestBtn?.addEventListener('click', handleSubmitDepositRequest);
            getElement('addAmountModalEl')?.addEventListener('show.bs.modal', () => { elements.depositAmountInput.value = ''; elements.depositTxnIdInput.value = ''; clearStatusMessage(elements.depositStatusMessage); });
            elements.allTransactionsBtn?.addEventListener('click', () => showSection('transactions-section', 'wallet-section'));
            elements.notificationBtn?.addEventListener('click', () => showSection('notifications-section', currentSectionId));
            elements.markAllReadBtnEl?.addEventListener('click', markAllNotificationsAsRead);
            document.body.addEventListener('click', (event) => { if (event.target.matches('.copy-btn, .copy-btn *')) { const btn = event.target.closest('.copy-btn'); if (btn?.dataset.target) copyToClipboard(btn.dataset.target); } if (event.target.matches('#shareReferralBtn, #shareReferralBtn *')) { const cel = getElement('referralCodeDisplay'); if (cel) shareReferral(cel.textContent); } });
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!auth || !db) { console.error("Firebase not ready. Cannot proceed."); return; }
            showLoader(true);
            loadAppSettings().then(() => {
                initializeEventListeners();
                updateGlobalUI(false);
                onAuthStateChanged(auth, handleAuthStateChange);
            }).catch(err => {
                console.error("CRITICAL: Initial settings load failed:", err);
                alert("Error loading app settings. Please try again later.");
                initializeEventListeners();
                updateGlobalUI(false);
                onAuthStateChanged(auth, handleAuthStateChange);
            });
        });
    </script>

</body>
</html>
